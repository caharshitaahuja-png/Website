<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harshita Ahuja & Associates | Financial Services Infographic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #E0E1DD;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 450px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 380px;
            }
        }
        .flowchart-step {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 1rem;
            border: 2px solid #415A77;
            background-color: #ffffff;
            color: #0D1B2A;
            border-radius: 0.5rem;
            min-height: 80px;
            font-weight: 600;
        }
        .flowchart-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #FFC300;
            margin: 0.5rem 0;
        }
        .llm-button {
            background-color: #FFC300;
            color: #0D1B2A;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
            cursor: pointer;
        }
        .llm-button:hover {
            background-color: #E6B000;
            transform: translateY(-1px);
        }
        .llm-button:disabled {
            background-color: #778DA9;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body class="text-[#0D1B2A]">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-6xl">

        <header class="text-center mb-12 md:mb-16">
            <h1 class="text-4xl md:text-5xl font-bold text-[#0D1B2A] tracking-tight">Harshita Ahuja & Associates</h1>
            <p class="text-lg md:text-xl text-[#415A77] mt-2 font-semibold">Strategic Financial Clarity. Trusted Partnership.</p>
        </header>

        <section class="bg-white rounded-xl shadow-lg p-6 md:p-8 mb-12 md:mb-16">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-center">
                <div class="md:col-span-2">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-3xl font-bold text-[#1B263B]">Our Commitment: Your Growth</h2>
                        <button id="read-commitment-button" class="llm-button text-sm p-2" onclick="readCommitment()">
                            <span id="tts-icon">&#128266;</span>
                            <span id="tts-text">Read Aloud ✨</span>
                        </button>
                    </div>
                    <p id="commitment-text" class="text-base text-[#415A77] leading-relaxed">
                        At Harshita Ahuja & Associates, we go beyond mere compliance. We offer holistic financial solutions designed to protect your assets, minimize tax liability, and optimize your business performance. We are your dedicated partners in navigating the complexities of finance, ensuring you are always positioned for success.
                    </p>
                </div>
                <div class="text-center bg-[#1B263B] rounded-lg p-6">
                     <p class="text-6xl md:text-7xl font-bold text-[#FFC300]">100%</p>
                     <p class="text-xl font-semibold text-white mt-2">Compliance Record</p>
                </div>
            </div>
        </section>

        <section class="mb-12 md:mb-16">
            <h2 class="text-3xl font-bold text-center text-[#1B263B] mb-8">Our Core Service Pillars</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                <div class="bg-white rounded-xl shadow-lg p-6 text-center hover:shadow-2xl transition-shadow duration-300">
                    <div class="text-4xl mb-4">&#128202;</div>
                    <h3 class="text-xl font-bold text-[#0D1B2A] mb-2">Assurance & Audit</h3>
                    <p class="text-[#415A77]">Providing credible and independent assurance to stakeholders through meticulous audits.</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 text-center hover:shadow-2xl transition-shadow duration-300">
                    <div class="text-4xl mb-4">&#128181;</div>
                    <h3 class="text-xl font-bold text-[#0D1B2A] mb-2">Tax & Regulatory Compliance</h3>
                    <p class="text-[#415A77]">Navigating GST and Income Tax laws to ensure seamless compliance and maximize savings.</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 text-center hover:shadow-2xl transition-shadow duration-300">
                    <div class="text-4xl mb-4">&#128176;</div>
                    <h3 class="text-xl font-bold text-[#0D1B2A] mb-2">Accounting & Financial Management</h3>
                    <p class="text-[#415A77]">Maintaining precise financial records for accurate reporting and generation of precise balance sheets.</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 text-center hover:shadow-2xl transition-shadow duration-300">
                    <div class="text-4xl mb-4">&#129309;</div>
                    <h3 class="text-xl font-bold text-[#0D1B2A] mb-2">Advisory & Problem Resolution</h3>
                    <p class="text-[#415A77]">Tackling complex financial challenges with customized, solution-oriented guidance.</p>
                </div>
            </div>
        </section>

        <section class="mb-12 md:mb-16">
            <h2 class="text-3xl font-bold text-center text-[#1B263B] mb-8">A Deeper Dive Into Our Expertise</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 md:gap-12 items-center">
                 <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
                    <h3 class="text-2xl font-bold text-[#0D1B2A] mb-4">Mastery in Taxation</h3>
                    <p class="text-[#415A77] mb-6">Our experts ensure you remain fully compliant with ever-evolving tax laws. This chart shows a typical breakdown of our client work, highlighting our deep experience in both GST and Income Tax domains, from routine filings to complex audits.</p>
                    <div class="chart-container">
                        <canvas id="taxServicesChart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
                    <h3 class="text-2xl font-bold text-[#0D1B2A] mb-4">Streamlined Audit & Reporting Process</h3>
                    <p class="text-[#415A77] mb-6">We follow a rigorous and transparent process for all audit and assurance engagements. This structured approach guarantees accuracy, efficiency, and clear communication from initial planning through to final reporting.</p>
                    <div class="flex flex-col">
                        <div class="flowchart-step">1. Initial Planning & Risk Assessment</div>
                        <div class="flowchart-arrow">&darr;</div>
                        <div class="flowchart-step">2. Fieldwork & Data Collection</div>
                        <div class="flowchart-arrow">&darr;</div>
                        <div class="flowchart-step">3. Analysis & Verification</div>
                        <div class="flowchart-arrow">&darr;</div>
                        <div class="flowchart-step">4. Final Reporting & Review</div>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="mb-12 md:mb-16">
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 md:gap-12 items-center">
                <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
                    <h3 class="text-2xl font-bold text-[#0D1B2A] mb-4">Handling Complex Financial Challenges</h3>
                    <p class="text-[#415A77] mb-6">While we excel at standard compliance, our true strength lies in solving non-routine financial problems. This chart illustrates our significant experience in providing high-level advisory for unique regulatory hurdles, restructuring, and other complex scenarios.</p>
                    <div class="chart-container">
                        <canvas id="caseComplexityChart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
                    <h3 class="text-2xl font-bold text-[#0D1B2A] mb-4">The Harshita Ahuja & Associates Advantage</h3>
                    <p class="text-[#415A77] mb-6">Choosing a financial partner is a critical decision. We are built on a foundation of three core principles that ensure our clients receive unparalleled service and value.</p>
                    <ul class="space-y-4">
                        <li class="flex items-start p-4 bg-gray-50 rounded-lg">
                            <span class="text-2xl text-[#FFC300] mr-4">&#10003;</span>
                            <div>
                                <h4 class="font-bold text-lg text-[#1B263B]">Personalized Service</h4>
                                <p class="text-[#415A77]">Direct access to experienced CA professionals who understand the unique details of your business and financial situation.</p>
                            </div>
                        </li>
                        <li class="flex items-start p-4 bg-gray-50 rounded-lg">
                            <span class="text-2xl text-[#FFC300] mr-4">&#10003;</span>
                             <div>
                                <h4 class="font-bold text-lg text-[#1B263B]">Proactive Guidance</h4>
                                <p class="text-[#415A77]">We focus on future-focused planning and strategic advice, not just historical reporting, to help you anticipate challenges and seize opportunities.</p>
                            </div>
                        </li>
                        <li class="flex items-start p-4 bg-gray-50 rounded-lg">
                             <span class="text-2xl text-[#FFC300] mr-4">&#10003;</span>
                            <div>
                                <h4 class="font-bold text-lg text-[#1B263B]">Integrity & Trust</h4>
                                <p class="text-[#415A77]">Our practice is founded on an unwavering commitment to ethical standards, transparency, and building long-term, trusted relationships.</p>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- START: GEMINI LLM FEATURES SECTION -->
        <section class="mb-12 md:mb-16">
            <h2 class="text-3xl font-bold text-center text-[#1B263B] mb-8">Your Financial Clarity Assistant ✨</h2>
            <p class="text-center text-[#415A77] mb-8 max-w-3xl mx-auto">Use our AI-powered assistants for quick clarity on compliance and strategic problem framing. Note: All AI-generated information must be confirmed by a certified professional.</p>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 md:gap-12">
                 <!-- Feature 1: Compliance Query Assistant -->
                <div id="compliance-card" class="bg-white rounded-xl shadow-2xl p-6 md:p-8 border-t-8 border-[#FFC300]">
                    <h3 class="text-2xl font-bold text-[#0D1B2A] mb-4">Regulatory Compliance Query ✨</h3>
                    <p class="text-[#415A77] mb-4">Ask a question about GST, Income Tax, or general compliance rules. Responses are grounded in real-time information.</p>
                    
                    <textarea id="compliance-input" rows="3" class="w-full p-3 border border-[#778DA9] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FFC300] text-[#0D1B2A]" placeholder="E.g., What is the current GST rate for educational services?"></textarea>
                    
                    <button id="query-button" class="llm-button w-full mt-4" onclick="getComplianceQuery()">
                        Get Compliant Answer
                    </button>

                    <div id="compliance-output" class="mt-6 p-4 bg-gray-50 rounded-lg min-h-[50px] border border-[#778DA9]">
                        <p class="text-[#415A77]">Results will appear here...</p>
                    </div>
                </div>

                <!-- Feature 2: Problem Brainstormer -->
                <div id="brainstormer-card" class="bg-white rounded-xl shadow-2xl p-6 md:p-8 border-t-8 border-[#1B263B]">
                    <h3 class="text-2xl font-bold text-[#0D1B2A] mb-4">Complex Problem Brainstormer ✨</h3>
                    <p class="text-[#415A77] mb-4">Describe a complex financial problem (e.g., audit discrepancy, valuation issue). Get a structured summary of considerations.</p>
                    
                    <textarea id="brainstormer-input" rows="3" class="w-full p-3 border border-[#778DA9] rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FFC300] text-[#0D1B2A]" placeholder="E.g., We found a major mismatch between the physical inventory count and the balance sheet value. What are the audit implications?"></textarea>
                    
                    <button id="brainstormer-button" class="llm-button w-full mt-4" onclick="getProblemSummary()">
                        Frame the Challenge
                    </button>

                    <div id="brainstormer-output" class="mt-6 p-4 bg-gray-50 rounded-lg min-h-[50px] border border-[#778DA9]">
                         <p class="text-[#415A77]">Key considerations will be listed here...</p>
                    </div>
                </div>
            </div>
        </section>
        <!-- END: GEMINI LLM FEATURES SECTION -->

        <footer class="text-center bg-[#0D1B2A] text-white rounded-xl shadow-lg p-8">
            <h2 class="text-3xl font-bold mb-2">Let's Connect</h2>
            <p class="text-[#E0E1DD] mb-6 max-w-2xl mx-auto">Ready to achieve financial clarity and drive your business forward? Reach out to us today for a consultation.</p>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4 sm:gap-8">
                <p class="font-semibold text-lg">
                    <span class="text-[#FFC300]">&#9993;</span> caharshitaahuja@gmail.com
                </p>
                <p class="font-semibold text-lg">
                    <span class="text-[#FFC300]">&#128205;</span> Dugri, Ludhiana, 141013
                </p>
            </div>
        </footer>

    </div>

    <script>
        const apiKey = ""; 
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + apiKey;
        const TTS_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=" + apiKey;
        let audioPlayer = null;

        const tooltipTitleCallback = {
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            const item = tooltipItems[0];
                            let label = item.chart.data.labels[item.dataIndex];
                            if (Array.isArray(label)) {
                              return label.join(' ');
                            } else {
                              return label;
                            }
                        }
                    }
                }
            }
        };

        const wrapLabels = (label, maxLen = 16) => {
            if (label.length <= maxLen) return label;
            const words = label.split(' ');
            let lines = [];
            let currentLine = '';

            words.forEach(word => {
                if ((currentLine + ' ' + word).length > maxLen && currentLine.length > 0) {
                    lines.push(currentLine.trim());
                    currentLine = word;
                } else {
                    currentLine = currentLine === '' ? word : currentLine + ' ' + word;
                }
            });
            lines.push(currentLine.trim());
            return lines;
        };

        const taxServicesCtx = document.getElementById('taxServicesChart').getContext('2d');
        new Chart(taxServicesCtx, {
            type: 'doughnut',
            data: {
                labels: ['GST Compliance', 'Income Tax Services', 'Audits & Assurance'].map(l => wrapLabels(l, 16)),
                datasets: [{
                    label: 'Service Breakdown',
                    data: [55, 35, 10],
                    backgroundColor: ['#1B263B', '#415A77', '#778DA9'],
                    borderColor: '#FFFFFF',
                    borderWidth: 4,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    ...tooltipTitleCallback.plugins,
                    legend: {
                        position: 'bottom',
                         labels: {
                            color: '#0D1B2A',
                            font: {
                                size: 14
                            }
                        }
                    }
                },
                cutout: '60%'
            }
        });
        
        const caseComplexityCtx = document.getElementById('caseComplexityChart').getContext('2d');
        new Chart(caseComplexityCtx, {
            type: 'bar',
            data: {
                labels: ['Quarter 1', 'Quarter 2', 'Quarter 3', 'Quarter 4'],
                datasets: [{
                    label: 'Standard Compliance Cases',
                    data: [120, 135, 140, 130],
                    backgroundColor: '#415A77',
                    borderRadius: 4
                }, {
                    label: 'Complex Advisory Cases',
                    data: [25, 30, 45, 35],
                    backgroundColor: '#FFC300',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#e0e1dd'
                        },
                        ticks: {
                           color: '#0D1B2A'
                        }
                    },
                    x: {
                         grid: {
                            display: false
                        },
                        ticks: {
                           color: '#0D1B2A'
                        }
                    }
                },
                plugins: {
                     ...tooltipTitleCallback.plugins,
                     legend: {
                        position: 'bottom',
                        labels: {
                            color: '#0D1B2A',
                             font: {
                                size: 14
                            }
                        }
                    }
                }
            }
        });
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Converts signed 16-bit PCM audio data into a WAV file blob.
        function pcmToWav(samples, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            
            const buffer = new ArrayBuffer(44 + samples.length * 2);
            const view = new DataView(buffer);
            
            // RIFF identifier
            writeString(view, 0, 'RIFF');
            // File size
            view.setUint32(4, 36 + samples.length * numChannels * (bitsPerSample / 8), true);
            // WAVE identifier
            writeString(view, 8, 'WAVE');
            // fmt chunk identifier
            writeString(view, 12, 'fmt ');
            // fmt chunk size (16)
            view.setUint32(16, 16, true);
            // Audio format (1 for PCM)
            view.setUint16(20, 1, true);
            // Channels (1)
            view.setUint16(22, numChannels, true);
            // Sample rate
            view.setUint32(24, sampleRate, true);
            // Byte rate (SampleRate * Channels * BitsPerSample / 8)
            view.setUint32(28, sampleRate * numChannels * (bitsPerSample / 8), true);
            // Block align (Channels * BitsPerSample / 8)
            view.setUint16(32, numChannels * (bitsPerSample / 8), true);
            // Bits per sample (16)
            view.setUint16(34, bitsPerSample, true);
            // data chunk identifier
            writeString(view, 36, 'data');
            // data chunk size
            view.setUint32(40, samples.length * numChannels * (bitsPerSample / 8), true);
            
            // Write the PCM data
            let offset = 44;
            for (let i = 0; i < samples.length; i++, offset += 2) {
                // PCM data is signed 16-bit
                view.setInt16(offset, samples[i], true);
            }
            
            return new Blob([view], { type: 'audio/wav' });
        }


        async function callGeminiApi(url, payload, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API call failed: ${response.status} - ${JSON.stringify(errorBody)}`);
                    }

                    const result = await response.json();
                    return result;

                } catch (error) {
                    if (i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        console.error("Gemini API Error after retries:", error);
                        throw new Error("Failed to get response from AI assistant.");
                    }
                }
            }
        }
        
        function formatOutput(text, sources) {
            let html = text.replace(/\n/g, '<br>');

            if (sources && sources.length > 0) {
                html += '<br><br><div class="text-xs text-[#1B263B] font-semibold mt-4">Sources:</div><ul class="list-disc list-inside text-xs space-y-1 mt-1">';
                sources.forEach((source, index) => {
                    html += `<li><a href="${source.uri}" target="_blank" class="text-[#415A77] hover:underline">${source.title || 'Source ' + (index + 1)}</a></li>`;
                });
                html += '</ul>';
            }
            return html;
        }

        async function getComplianceQuery() {
            const inputElement = document.getElementById('compliance-input');
            const outputElement = document.getElementById('compliance-output');
            const button = document.getElementById('query-button');
            const userQuery = inputElement.value.trim();

            if (!userQuery) {
                outputElement.innerHTML = '<p class="text-red-500">Please enter a compliance question.</p>';
                return;
            }

            button.disabled = true;
            button.innerHTML = 'Searching...';
            outputElement.innerHTML = '<p class="text-[#415A77] font-semibold animate-pulse">Consulting the regulatory database...</p>';

            const systemPrompt = "You are a helpful CA assistant focused on compliance for the Indian context (GST, Income Tax, ROC). Provide a concise and accurate response to the user's query, citing the sources. State clearly that this is general guidance and not a professional opinion.";
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const result = await callGeminiApi(API_URL, payload);
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                    
                    outputElement.innerHTML = formatOutput(text, sources);

                } else {
                    outputElement.innerHTML = '<p class="text-red-500">Could not generate a response. Please try rephrasing your query.</p>';
                }

            } catch (error) {
                outputElement.innerHTML = `<p class="text-red-500">An error occurred: ${error.message}</p>`;
            } finally {
                button.disabled = false;
                button.innerHTML = 'Get Compliant Answer';
            }
        }

        async function getProblemSummary() {
            const inputElement = document.getElementById('brainstormer-input');
            const outputElement = document.getElementById('brainstormer-output');
            const button = document.getElementById('brainstormer-button');
            const userQuery = inputElement.value.trim();

            if (!userQuery) {
                outputElement.innerHTML = '<p class="text-red-500">Please describe your financial problem.</p>';
                return;
            }

            button.disabled = true;
            button.innerHTML = 'Framing...';
            outputElement.innerHTML = '<p class="text-[#415A77] font-semibold animate-pulse">Structuring the problem for review...</p>';

            const systemPrompt = "You are a high-level financial strategist. Given a complex financial issue or audit discrepancy, structure an initial thought process for a CA. Provide a list of 3-5 key 'Initial Considerations' and a 'Next Step Recommendation.' Emphasize that professional consultation is required. Use only bold formatting for headings.";
            
            const payload = {
                contents: [{ parts: [{ text: `Analyze this complex financial problem: ${userQuery}` }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const result = await callGeminiApi(API_URL, payload);
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    outputElement.innerHTML = formatOutput(text);
                } else {
                    outputElement.innerHTML = '<p class="text-red-500">Could not frame the challenge. Please describe the problem more clearly.</p>';
                }

            } catch (error) {
                outputElement.innerHTML = `<p class="text-red-500">An error occurred: ${error.message}</p>`;
            } finally {
                button.disabled = false;
                button.innerHTML = 'Frame the Challenge';
            }
        }
        
        async function readCommitment() {
            const button = document.getElementById('read-commitment-button');
            const ttsTextSpan = document.getElementById('tts-text');
            const ttsIconSpan = document.getElementById('tts-icon');
            const textToSpeak = document.getElementById('commitment-text').textContent.trim();

            // Stop any existing audio
            if (audioPlayer && !audioPlayer.paused) {
                audioPlayer.pause();
                audioPlayer = null;
                ttsIconSpan.innerHTML = '&#128266;'; // Speaker icon
                ttsTextSpan.textContent = 'Read Aloud ✨';
                button.disabled = false;
                return;
            }
            
            button.disabled = true;
            ttsIconSpan.innerHTML = '&#8987;'; // Hourglass/loading icon
            ttsTextSpan.textContent = 'Generating...';

            const payload = {
                contents: [{ parts: [{ text: textToSpeak }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const result = await callGeminiApi(TTS_API_URL, payload);
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const sampleRate = 16000; // Assuming 16000 Hz for TTS output (L16)

                if (audioData) {
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    audioPlayer = new Audio(audioUrl);
                    audioPlayer.play();

                    ttsIconSpan.innerHTML = '&#9209;'; // Pause icon
                    ttsTextSpan.textContent = 'Stop Reading';
                    
                    audioPlayer.onended = () => {
                        ttsIconSpan.innerHTML = '&#128266;';
                        ttsTextSpan.textContent = 'Read Aloud ✨';
                        button.disabled = false;
                        audioPlayer = null;
                    };
                    
                } else {
                    throw new Error("No audio data received.");
                }

            } catch (error) {
                ttsIconSpan.innerHTML = '&#10060;'; // Error icon
                ttsTextSpan.textContent = 'Error';
                console.error("TTS Playback Error:", error);
            } finally {
                // Button remains disabled until audio starts or fails, 
                // but re-enables on end/stop/error.
                if (!audioPlayer || audioPlayer.paused) {
                    button.disabled = false;
                }
            }
        }
    </script>
</body>
</html>
